# نظام فحص حالة المدفوعات - بديل Webhooks

## نظرة عامة
تم إنشاء نظام بديل لـ Webhooks لفحص حالة المدفوعات في Paymennt API. هذا النظام يعتمد على الاستعلام الدوري (Polling) بدلاً من انتظار الإشعارات التلقائية.

## المكونات الرئيسية

### 1. Command: CheckPaymentStatus
```bash
# فحص حالة المدفوعات المعلقة
php artisan payments:check-status

# فحص جميع المدفوعات (إجبارياً)
php artisan payments:check-status --force
```

### 2. Job: CheckPaymentStatusJob
- يعمل في الخلفية
- يمكن تشغيله لدفعة واحدة أو جميع المدفوعات
- يتعامل مع الأخطاء وإعادة المحاولة

### 3. جدولة التشغيل التلقائي
- يعمل كل دقيقتين تلقائياً
- يمكن تعديل الفترة حسب الحاجة

## كيفية العمل

### الفحص الدوري
1. **كل دقيقتين**: يتم تشغيل الأمر تلقائياً
2. **فحص ذكي**: يتحقق فقط من المدفوعات التي لم يتم فحصها مؤخراً (آخر 5 دقائق)
3. **تحديث الحالة**: يتم تحديث حالة الدفع في قاعدة البيانات

### الفحص اليدوي
1. **دفعة واحدة**: من خلال زر "تحديث الحالة" في الواجهة
2. **جميع المدفوعات**: من خلال زر "فحص جميع المدفوعات"

## المزايا

✅ **بدون Webhooks**: لا حاجة لإعداد Webhooks مع Paymennt
✅ **تحكم كامل**: يمكنك تحديد متى وكيف يتم الفحص
✅ **موثوقية**: يعمل حتى لو فشلت Webhooks
✅ **مرونة**: يمكن تعديل الفترات حسب الحاجة
✅ **تتبع**: يسجل جميع عمليات الفحص

## الإعداد

### 1. تشغيل Migration
```bash
php artisan migrate
```

### 2. إعداد Cron Job (للخادم)
```bash
* * * * * cd /path/to/your/project && php artisan schedule:run >> /dev/null 2>&1
```

### 3. اختبار النظام
```bash
# اختبار فحص حالة واحدة
php artisan payments:check-status

# اختبار فحص جميع المدفوعات
php artisan payments:check-status --force
```

## مراقبة النظام

### السجلات (Logs)
- جميع عمليات الفحص تُسجل في `storage/logs/laravel.log`
- يمكن تتبع الأخطاء والمشاكل

### قاعدة البيانات
- حقل `last_status_check`: آخر مرة تم فيها فحص الحالة
- حقل `status`: الحالة الحالية (pending, paid, cancelled, expired)

## استكشاف الأخطاء

### مشكلة: لا يتم تحديث الحالة
1. تحقق من سجلات Laravel
2. تأكد من صحة API Keys
3. تحقق من اتصال الإنترنت

### مشكلة: بطء في الفحص
1. قلل عدد المدفوعات في كل عملية
2. زد الفترة بين الفحوصات
3. استخدم Queue Jobs للعمليات الكبيرة

## التخصيص

### تغيير فترة الفحص
```php
// في app/Console/Kernel.php
$schedule->command('payments:check-status')->everyMinute(); // كل دقيقة
$schedule->command('payments:check-status')->everyFiveMinutes(); // كل 5 دقائق
```

### تغيير فترة الفحص الذكي
```php
// في app/Models/PaymentLink.php
public function scopeNeedsStatusCheck($query, $minutes = 10) // 10 دقائق بدلاً من 5
```

## ملاحظات مهمة

⚠️ **معدل API**: لا تفرط في استخدام API لتجنب القيود
⚠️ **الأداء**: استخدم Queues للعمليات الكبيرة
⚠️ **النسخ الاحتياطية**: احتفظ بنسخ احتياطية من قاعدة البيانات
⚠️ **المراقبة**: راقب السجلات بانتظام

## الدعم

للمساعدة أو الاستفسارات، راجع:
- سجلات Laravel
- وثائق Paymennt API
- فريق التطوير
